/**
 * Sorter v0.1  ‎2015-01-07 20:15‎ code by ‎Sanonz <sanonz@126.com>‎
 */

(function(){function r(a){return"function"===typeof a}function w(){document.getSelection?document.getSelection().removeAllRanges():document.selection.empty()}function t(a,b){var c,d;if(!l(a))return!1;d=a.parentNode;(c=a.nextSibling)?d.insertBefore(b,c):d.appendChild(b)}function x(a,b){var c,d=0,g=[];if(!l(a))return g;for(c=a.children;c.item(d);)m(c[d],b)&&g.push(c[d]),++d;return g}function y(a,b,c){for(var d=null;(a=a[c?"nextSibling":"previousSibling"])&&(1!=a.nodeType||!(d=b?z(a,b)&&(d=a):d=a)););return d}function A(a,b){return y(a,b,!0)}function s(a,b){if(l(a)&&"object"===typeof b)for(var c in b)a.style[c]=b[c];return a}function B(a){var b=document.documentElement,c=document.body;a.pageX||(a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b&&b.clientLeft||c&&c.clientLeft||0));a.pageY||(a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b&&b.clientTop||c&&c.clientTop||0))}function m(a,b){return l(a)&&b&&a.className?(new RegExp("\\b"+b+"\\b")).test(a.className):!1}function C(a,b){m(a,b)||(a.className&&(b=" "+b),a.className+=b);return a}function l(a){return"object"===typeof a&&(1===a.nodeType||9===a.nodeType)}function z(a,b){b=String(b);switch(b.charAt(0)){case ".":return m(a,b.substr(1));case "#":return"#"+a.id==b}return!1}function u(a,b,c,d,g){var e;if("object"!==typeof b||"function"!==typeof c)return!1;e=E.events;a=String(a);types=a.replace(/(^\s+|\s$)/,"").split(/\s+/);b.listenEventId=e[a]?e[a].length:(e[a]=[],0);e[a].push(function(){c.apply(g||b,arguments)});for(var h=0,f=types.length;h<f;h++)b.addEventListener?b.addEventListener(types[h],e[a][b.listenEventId],d):b.attachEvent("on"+types[h],e[a][b.listenEventId]);return b}function F(a,b,c,d,g,e){if(!l(b)||"function"!==typeof d)return!1;u(a,b,function(a){var f;for(f=a.target||a.srcElement;f;){if(z(f,c)){a._currentTarget=f;d.call(e||b,a);break}f=f.parentNode}},g,e)}function D(a,b){var c=[];a=String(a);switch(a.charAt(0)){case ".":var d=document.body,g=a.substr(1),e=0,h=[];l(d)||(d=document.body);if(d.querySelectorAll)a=d.querySelectorAll("."+g);else{for(var d=d.getElementsByTagName("*"),e=0,f=d.length;e<f;e++)m(d[e],g)&&h.push(d[e]);a=h}g=0;for(e=a.length;g<e;g++)c.push(new v(a[g],b));break;case "#":(a=document.getElementById(a.substr(1)))&&c.push(new v(a,b))}return c}var v=function(a,b){if(!(this instanceof arguments.callee))return new arguments.callee(a,b);var c={vertical:!0,horizontal:!0,indentation:30,borderWidth:2,dataDepth:"data-sorter-depth",rowClassName:"sorter-row",depthClassName:"sorter-depth-",heplerClassName:"sorter-helper",sublistClassName:"sorter-sublist",placeholderClassName:"sorter-placeholder",onStart:null,onMove:null,onEnd:null};if("object"!==typeof c||"object"!==typeof b)throw new TypeError("Arguments type failed!");for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);this.settings=c;this.dragdrop={list:[],timeout:0,move:!1,subitem:[],target:null,sublist:null,isTouch:!1,parentDepth:0,tbody:a,placeholder:null,depth:{s:0,e:0},start:{x:0,y:0},changed:{x:0,y:0},position:{x:0,y:0},indentation:{x:0,y:0},onStart:[],onMove:[],onEnd:[]};r(this.settings.onStart)&&this.dragdrop.onStart.push(this.settings.onStart);r(this.settings.onMove)&&this.dragdrop.onStart.push(this.settings.onMove);r(this.settings.onEnd)&&this.dragdrop.onStart.push(this.settings.onEnd);this.init()},E={events:{}};v.prototype={init:function(){F("mousedown touchstart",this.dragdrop.tbody,"."+this.settings.rowClassName,this.dragdropHandle,!1,this);u("mousemove touchmove mouseup touchend",document,this.dragdropHandle,!1,this);u("wheel",document,this.dragdropHandle,!1,this);this.dragdrop.placeholder=document.createElement("div");C(this.dragdrop.placeholder,this.settings.rowClassName+" "+this.settings.placeholderClassName)},dragdropHandle:function(a){switch(!0){case "touchstart"==a.type||"mousedown"==a.type:this.dragdropStart(a);break;case "touchmove"==a.type||"mousemove"==a.type:this.dragdrop.move&&this.dragdropMove(a);break;case "touchend"==a.type||"mouseup"==a.type:this.dragdropEnd(a);break;case "wheel"==a.type:this.dragdrop.move&&this.dragdropWheel(a)}},dragdropStart:function(a){var b,c=this,d=c.dragdrop,g=c.settings;d.move||(clearTimeout(d.timeout),d.isTouch="touchstart"==a.type,B(a),b=a.touches||[],d.start.x=d.changed.x=b[0]?b[0].pageX:a.pageX,d.start.y=d.changed.y=b[0]?b[0].pageY:a.pageY,d.timeout=setTimeout(function(){var b,h,f;w();d.move=!0;d.target=a._currentTarget;f=d.target;h=b=0;if(l(f))for(;f;)b+=f.offsetTop,h+=f.offsetLeft,f=f.offsetParent;d.depth.e=0;d.depth.s=c.depth(d.target)||0;d.sublist=x(d.target,g.sublistClassName)[0];if(d.sublist){f=d.subitem=c.findSubitem(d.depth.s);for(var k=0,n=f.length;k<n;k++)d.sublist.appendChild(f[k])}f=d.target;f=l(f)?document.defaultView?document.defaultView.getComputedStyle(f,null):f.currentStyle:"";d.position.y=b-(parseFloat(f.marginTop)||0);d.position.x=h-(parseFloat(f.marginLeft)||0);b=d.target.offsetWidth;h=d.target.offsetHeight-(parseFloat(f.borderTopWidth)||0)-(parseFloat(f.borderBottomWidth)||0)-g.borderWidth;C(d.target,g.heplerClassName);s(d.target,{top:d.position.y+"px",left:d.position.x+"px",width:b+"px"});b=x(d.tbody,g.rowClassName);for(k in b)b.hasOwnProperty(k)&&!m(b[k],g.heplerClassName)&&d.list.push(b[k]);s(d.placeholder,{height:h+"px"});c.depth(d.placeholder,d.depth.s);t(d.target,d.placeholder);c.setParentDepth();k=0;for(n=d.onStart.length;k<n;k++)d.onStart[k](a,d.target)},d.isTouch?1E3:0))},dragdropMove:function(a){var b,c=this.dragdrop,d=c.target,g=d.offsetTop,e,h=e=0,f=0,k=0,n=0,m=g+d.offsetHeight;c.isTouch&&1==a.touches.length&&a.preventDefault();w();B(a);f=c.isTouch?a.touches[0].pageX:a.pageX;k=c.isTouch?a.touches[0].pageY:a.pageY;e=f-c.changed.x;h=k-c.changed.y;c.position.x+=e;c.position.y+=h;c.indentation.x+=e;c.indentation.y+=h;s(d,{top:c.position.y+"px",left:c.position.x+"px"});this.settings.horizontal&&(c.depth.e=Math.floor(c.indentation.x/this.settings.indentation),e=this.limitDepth(c.depth.s+c.depth.e),this.depth(c.placeholder,e));c.changed.x=f;c.changed.y=k;if(this.settings.vertical)for(f=0,k=c.list.length;f<k;f++){e=c.list[f];var q,p=0;if(e!==d[0])if(p=e.offsetHeight/2,b=e.offsetTop,p=b+p,(q=c.list[f+1])?(b=q.offsetTop,q=q.offsetHeight/2,0<h?m>p&&m<b+q&&(n=2):g>p&&g<b+q?n=2:p>g&&(n=1)):m>p&&(n=2),1==n){g=e;h=c.placeholder;l(g)&&g.parentNode.insertBefore(h,g);this.setParentDepth();break}else if(2==n){t(e,c.placeholder);this.setParentDepth();break}}f=0;for(k=c.onMove.length;f<k;f++)c.onMove[f](a,d)},dragdropEnd:function(a){var b=this.dragdrop,c,d,g;if(!(a.touches&&0<a.touches.length)&&(clearTimeout(b.timeout),b.move)){b.move=!1;b.list.length=0;b.start.x=b.changed.x=b.indentation.x=0;b.start.y=b.changed.y=b.indentation.y=0;c=b.placeholder;var e=b.target;l(c)&&c.parentNode.replaceChild(e,c);c=this.limitDepth(b.depth.s+b.depth.e);g=c-b.depth.s;d=this.getSubitem();for(e=d.length;0<=e;e--)d.item(e)&&(this.depth(d[e],this.depth(d[e])+g),t(this.dragdrop.target,d[e]));e=b.target;d=this.settings.heplerClassName;m(e,d)&&(e.className=e.className.replace(new RegExp("\\b"+d+"\\b"),"").replace(/(^\s+|\s+$)/,"").replace(/\s{2,}/," "));s(b.target,{top:"",left:"",width:""});this.depth(b.target,c);e=0;for(c=b.onEnd.length;e<c;e++)b.onEnd[e](a,b.target)}},dragdropWheel:function(a){this.dragdropMove(a)},depth:function(a,b){var c=new RegExp("\\b"+this.settings.depthClassName+"(\\d+)\\b");a=l(a)?a:this.dragdrop.target;if(0!==b&&!b)return(c=c.exec(a.className))?+c[1]:0;b=parseInt(b)||0;b=0>b?0:b;c.test(a.className)?a.className=a.className.replace(c,this.settings.depthClassName+b):a.className+=" "+this.settings.depthClassName+b},removeDepth:function(a,b){b=l(b)?b:this.dragdrop.target;b.className=b.className.replace(new RegExp("\\b"+this.settings.depthClassName+"\\d+\\b"),"").replace(/(^\s+|\s+$)/,"").replace(/\s{2,}/," ")},limitDepth:function(a){var b=this.dragdrop.parentDepth;return a>=b+1?b+1:a>=b/2?b:0},setParentDepth:function(){var a;a=this.nearDetph(!0);return this.dragdrop.parentDepth=a},nearDetph:function(a){for(var b=this.dragdrop.placeholder;b=[y,A][a?0:1](b,"."+this.settings.rowClassName);)if(!m(b,this.settings.heplerClassName))return this.depth(b);return-1},getSubitem:function(){return this.dragdrop.sublist.children},findSubitem:function(a){var b,c,d=[];for(b=this.dragdrop.target;b=A(b,"."+this.settings.rowClassName);)if((c=this.depth(b))&&c>a)d.push(b);else break;return d},on:function(a,b){var c=this.dragdrop;a=String(a);a="on"+a.charAt(0).toUpperCase()+a.substring(1);c[a]||(c[a]=[]);r(b)&&c[a].push(b);return this}};"function"===typeof window.define&&define.amd?define("Sorter",function(){return D}):window.Sorter=D})();